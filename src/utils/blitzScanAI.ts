// Tipos para el agente BlitzScanIA
export type AIQueryType = 
  | 'security_report'    // Reporte de seguridad espec√≠fico
  | 'general_chat'       // Chat general
  | 'vulnerability_analysis' // An√°lisis de vulnerabilidades
  | 'security_advice'    // Consejos de seguridad
  | 'tool_recommendation' // Recomendaci√≥n de herramientas
  | 'risk_assessment'    // Evaluaci√≥n de riesgos
  | 'technical_explanation' // Explicaci√≥n t√©cnica
  | 'compliance_check'   // Verificaci√≥n de cumplimiento
  | 'incident_response'  // Respuesta a incidentes
  | 'penetration_testing' // Testing de penetraci√≥n

export interface AIQuery {
  type: AIQueryType;
  scanType?: string;
  scanData?: any;
  userMessage?: string;
  context?: string;
  conversationHistory?: Array<{sender: 'user' | 'bot', text: string}>;
  currentScan?: any;
}

// Sistema de contexto para mantener el estado de la conversaci√≥n
export interface ConversationContext {
  currentScan?: {
    type: string;
    data: any;
    url: string;
    timestamp: string;
  };
  conversationHistory: Array<{sender: 'user' | 'bot', text: string}>;
  userExpertise: 'beginner' | 'intermediate' | 'expert';
  focusArea?: 'web_security' | 'network_security' | 'application_security' | 'social_engineering';
  previousTopics: string[];
}

// Prompts espec√≠ficos para cada tipo de consulta
export const AI_PROMPTS = {
  // Reporte de seguridad estructurado
  security_report: (scanType: string, scanData: any) => `
Eres BlitzScanIA, un experto asistente de ciberseguridad especializado en an√°lisis de seguridad web.

TAREA: Generar un reporte de seguridad profesional y estructurado.

INSTRUCCIONES:
- Analiza los datos del escaneo proporcionados
- Identifica vulnerabilidades y riesgos espec√≠ficos
- Proporciona recomendaciones pr√°cticas y priorizadas
- Usa un tono profesional pero accesible
- Estructura la respuesta con secciones claras

FORMATO DEL REPORTE:
## üîç Resumen Ejecutivo
[Breve resumen de los hallazgos principales]

## üö® Vulnerabilidades Detectadas
[Lista de vulnerabilidades encontradas con nivel de riesgo]

## üìä An√°lisis de Riesgo
[Evaluaci√≥n del impacto y probabilidad]

## üõ°Ô∏è Recomendaciones Prioritarias
[Acciones espec√≠ficas para mitigar riesgos]

## üìà Medidas Preventivas
[Estrategias para prevenir futuros incidentes]

TIPO DE ESCANEO: ${scanType}
DATOS DEL ESCANEO:
${typeof scanData === 'string' ? scanData : JSON.stringify(scanData, null, 2)}

Genera el reporte siguiendo el formato especificado.
`,

  // Chat general de ciberseguridad
  general_chat: (userMessage: string) => `
Eres BlitzScanIA, un asistente de ciberseguridad amigable y experto.

CONTEXTO: El usuario est√° haciendo una pregunta general sobre ciberseguridad.

INSTRUCCIONES:
- Responde de forma clara y accesible
- Proporciona informaci√≥n pr√°ctica y √∫til
- SOLO recomienda herramientas que est√°n disponibles en BlitzScan
- Mant√©n un tono conversacional pero profesional
- No generes reportes estructurados para preguntas simples
- NO menciones herramientas externas como Nessus, OpenVAS, OWASP ZAP, etc.

HERRAMIENTAS DISPONIBLES EN BLITZSCAN:
- Fuzzing Web: B√∫squeda de directorios y archivos ocultos
- Nmap Scan: Escaneo de puertos y servicios
- WHOIS Lookup: Informaci√≥n del dominio y registrante
- Subfinder: Enumeraci√≥n de subdominios
- ParamSpider: Extracci√≥n de par√°metros vulnerables
- WhatWeb: Fingerprinting de tecnolog√≠as web
- theHarvester: Recolecci√≥n de correos y hosts p√∫blicos

PREGUNTA DEL USUARIO: ${userMessage}

Responde de manera natural y √∫til, recomendando SOLO las herramientas de BlitzScan.
`,

  // An√°lisis espec√≠fico de vulnerabilidades
  vulnerability_analysis: (scanData: any, context: string) => `
Eres BlitzScanIA, especialista en an√°lisis de vulnerabilidades.

TAREA: Analizar vulnerabilidades espec√≠ficas en los datos proporcionados.

INSTRUCCIONES:
- Identifica vulnerabilidades espec√≠ficas
- Eval√∫a el nivel de riesgo de cada una
- Explica el impacto potencial
- Sugiere m√©todos de explotaci√≥n (para prop√≥sitos educativos)
- Proporciona contramedidas espec√≠ficas

CONTEXTO: ${context}
DATOS PARA ANALIZAR:
${typeof scanData === 'string' ? scanData : JSON.stringify(scanData, null, 2)}

Realiza un an√°lisis detallado de las vulnerabilidades encontradas.
`,

  // Consejos de seguridad
  security_advice: (topic: string) => `
Eres BlitzScanIA, consultor de seguridad experto.

TAREA: Proporcionar consejos pr√°cticos de seguridad.

INSTRUCCIONES:
- Ofrece consejos espec√≠ficos y accionables
- Explica el "por qu√©" de cada recomendaci√≥n
- Incluye mejores pr√°cticas de la industria
- Mant√©n un tono educativo y √∫til

TEMA: ${topic}

Proporciona consejos de seguridad relevantes y pr√°cticos.
`,

  // Recomendaci√≥n de herramientas
  tool_recommendation: (context: string) => `
Eres BlitzScanIA, experto en herramientas de ciberseguridad.

TAREA: Recomendar herramientas apropiadas SOLO de las disponibles en BlitzScan.

INSTRUCCIONES:
- Sugiere SOLO herramientas que est√°n en BlitzScan
- Explica por qu√© cada herramienta es √∫til para el contexto
- NO menciones herramientas externas como Nessus, OpenVAS, OWASP ZAP, etc.
- Considera el nivel de experiencia del usuario
- Proporciona casos de uso espec√≠ficos

HERRAMIENTAS DISPONIBLES EN BLITZSCAN:
- Fuzzing Web: Para encontrar rutas sensibles, archivos de backup, paneles de administraci√≥n
- Nmap Scan: Para identificar puertos abiertos, servicios activos, vulnerabilidades de red
- WHOIS Lookup: Para informaci√≥n del dominio, fechas de expiraci√≥n, datos del registrante
- Subfinder: Para encontrar subdominios, ampliar la superficie de ataque
- ParamSpider: Para encontrar par√°metros URL, posibles puntos de inyecci√≥n
- WhatWeb: Para identificar tecnolog√≠as, frameworks, versiones de software
- theHarvester: Para encontrar correos electr√≥nicos, hosts, informaci√≥n de la organizaci√≥n

CONTEXTO: ${context}

Recomienda SOLO herramientas de BlitzScan apropiadas para este contexto.
`,

  // Evaluaci√≥n de riesgos
  risk_assessment: (data: any) => `
Eres BlitzScanIA, especialista en evaluaci√≥n de riesgos de seguridad.

TAREA: Evaluar el nivel de riesgo de los hallazgos.

INSTRUCCIONES:
- Clasifica los riesgos por severidad (Alto/Medio/Bajo)
- Explica el impacto potencial de cada riesgo
- Considera la probabilidad de explotaci√≥n
- Proporciona m√©tricas de riesgo cuando sea posible
- Sugiere prioridades de mitigaci√≥n

DATOS PARA EVALUAR:
${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}

Realiza una evaluaci√≥n de riesgos detallada.
`,

  // Explicaci√≥n t√©cnica
  technical_explanation: (topic: string, context?: ConversationContext) => `
Eres BlitzScanIA, experto t√©cnico en ciberseguridad.

TAREA: Proporcionar una explicaci√≥n t√©cnica clara y detallada.

INSTRUCCIONES:
- Explica el concepto de manera t√©cnica pero accesible
- Incluye ejemplos pr√°cticos cuando sea relevante
- Menciona herramientas relacionadas si aplica
- Considera el nivel de experiencia del usuario
- Proporciona contexto hist√≥rico o de la industria cuando sea √∫til

TEMA A EXPLICAR: ${topic}
${context?.currentScan ? `CONTEXTO DEL ESCANEO ACTUAL: ${context.currentScan.type} en ${context.currentScan.url}` : ''}

Proporciona una explicaci√≥n t√©cnica completa y detallada.
`,

  // Verificaci√≥n de cumplimiento
  compliance_check: (standard: string, context?: ConversationContext) => `
Eres BlitzScanIA, especialista en cumplimiento y regulaciones de seguridad.

TAREA: Verificar el cumplimiento con est√°ndares de seguridad.

INSTRUCCIONES:
- Identifica los requisitos relevantes del est√°ndar
- Eval√∫a el nivel de cumplimiento actual
- Identifica brechas de cumplimiento
- Proporciona recomendaciones espec√≠ficas
- Menciona consecuencias de no cumplir
- Incluye mejores pr√°cticas de la industria

EST√ÅNDAR/CUMPLIMIENTO: ${standard}
${context?.currentScan ? `CONTEXTO DEL ESCANEO: ${context.currentScan.type} en ${context.currentScan.url}` : ''}

Realiza una evaluaci√≥n de cumplimiento detallada.
`,

  // Respuesta a incidentes
  incident_response: (incident: string, context?: ConversationContext) => `
Eres BlitzScanIA, especialista en respuesta a incidentes de seguridad.

TAREA: Proporcionar gu√≠a para responder a un incidente de seguridad.

INSTRUCCIONES:
- Define los pasos inmediatos a seguir
- Establece prioridades de respuesta
- Identifica stakeholders que deben ser notificados
- Sugiere herramientas de an√°lisis forense
- Proporciona plantillas de documentaci√≥n
- Incluye consideraciones legales y regulatorias

INCIDENTE DESCRITO: ${incident}
${context?.currentScan ? `ESCANEO RELACIONADO: ${context.currentScan.type} en ${context.currentScan.url}` : ''}

Proporciona un plan de respuesta a incidentes detallado.
`,

  // Testing de penetraci√≥n
  penetration_testing: (target: string, context?: ConversationContext) => `
Eres BlitzScanIA, experto en testing de penetraci√≥n y hacking √©tico.

TAREA: Proporcionar gu√≠a para testing de penetraci√≥n.

INSTRUCCIONES:
- Define el alcance del pentest
- Sugiere metodolog√≠as apropiadas (OWASP, NIST, etc.)
- Recomienda herramientas espec√≠ficas
- Establece reglas de engagement
- Proporciona plantillas de reporte
- Incluye consideraciones √©ticas y legales

OBJETIVO DEL PENTEST: ${target}
${context?.currentScan ? `CONTEXTO DEL ESCANEO: ${context.currentScan.type} en ${context.currentScan.url}` : ''}

Proporciona una gu√≠a completa para testing de penetraci√≥n.
`
};

// Herramientas disponibles en BlitzScan
export const BLITZSCAN_TOOLS = {
  fuzzing: {
    name: 'Fuzzing Web',
    description: 'B√∫squeda de directorios y archivos ocultos',
    use_case: 'Encontrar rutas sensibles, archivos de backup, paneles de administraci√≥n'
  },
  nmap: {
    name: 'Nmap Scan',
    description: 'Escaneo de puertos y servicios',
    use_case: 'Identificar puertos abiertos, servicios activos, vulnerabilidades de red'
  },
  whois: {
    name: 'WHOIS Lookup',
    description: 'Informaci√≥n del dominio y registrante',
    use_case: 'Informaci√≥n del dominio, fechas de expiraci√≥n, datos del registrante'
  },
  subfinder: {
    name: 'Subfinder',
    description: 'Enumeraci√≥n de subdominios',
    use_case: 'Encontrar subdominios, ampliar la superficie de ataque'
  },
  paramspider: {
    name: 'ParamSpider',
    description: 'Extracci√≥n de par√°metros vulnerables',
    use_case: 'Encontrar par√°metros URL, posibles puntos de inyecci√≥n'
  },
  whatweb: {
    name: 'WhatWeb',
    description: 'Fingerprinting de tecnolog√≠as web',
    use_case: 'Identificar tecnolog√≠as, frameworks, versiones de software'
  },
  theharvester: {
    name: 'theHarvester',
    description: 'Recolecci√≥n de correos y hosts p√∫blicos',
    use_case: 'Encontrar correos electr√≥nicos, hosts, informaci√≥n de la organizaci√≥n'
  }
};

// Funci√≥n para obtener recomendaciones de herramientas espec√≠ficas de BlitzScan
export function getBlitzScanToolRecommendations(context: string): string[] {
  const recommendations = [];
  
  if (context.toLowerCase().includes('backend') || context.toLowerCase().includes('api')) {
    recommendations.push('Fuzzing Web - Para encontrar endpoints ocultos y rutas sensibles');
    recommendations.push('Nmap Scan - Para identificar puertos y servicios expuestos');
    recommendations.push('ParamSpider - Para encontrar par√°metros vulnerables en APIs');
  }
  
  if (context.toLowerCase().includes('dominio') || context.toLowerCase().includes('sitio web')) {
    recommendations.push('WHOIS Lookup - Para informaci√≥n del dominio y registrante');
    recommendations.push('Subfinder - Para encontrar subdominios relacionados');
    recommendations.push('WhatWeb - Para identificar tecnolog√≠as del sitio');
  }
  
  if (context.toLowerCase().includes('vulnerabilidad') || context.toLowerCase().includes('seguridad')) {
    recommendations.push('Nmap Scan - Para identificar servicios vulnerables');
    recommendations.push('Fuzzing Web - Para encontrar rutas sensibles');
    recommendations.push('ParamSpider - Para detectar par√°metros vulnerables');
  }
  
  if (context.toLowerCase().includes('informaci√≥n') || context.toLowerCase().includes('reconocimiento')) {
    recommendations.push('WHOIS Lookup - Para informaci√≥n del dominio');
    recommendations.push('theHarvester - Para encontrar correos y hosts');
    recommendations.push('WhatWeb - Para fingerprinting de tecnolog√≠as');
  }
  
  // Si no hay contexto espec√≠fico, recomendar herramientas generales
  if (recommendations.length === 0) {
    recommendations.push('Nmap Scan - Para un an√°lisis completo de puertos y servicios');
    recommendations.push('Fuzzing Web - Para encontrar rutas y archivos ocultos');
    recommendations.push('WHOIS Lookup - Para informaci√≥n del dominio');
  }
  
  return recommendations;
}

// Funci√≥n para determinar el tipo de consulta basado en el mensaje del usuario
export function classifyQuery(
  userMessage: string, 
  scanType?: string, 
  scanData?: any,
  context?: ConversationContext
): AIQueryType {
  const message = userMessage.toLowerCase();
  
  // Palabras clave m√°s espec√≠ficas y robustas
  const keywords = {
    security_report: [
      'reporte', 'report', 'an√°lisis completo', 'evaluaci√≥n completa', 
      'genera reporte', 'crea reporte', 'haz un reporte', 'reporte de seguridad'
    ],
    vulnerability_analysis: [
      'vulnerabilidad', 'vulnerability', 'exploit', 'ataque', 'brecha', 'falla',
      'an√°lisis de vulnerabilidades', 'buscar vulnerabilidades', 'encontrar vulnerabilidades',
      'exploit', 'exploitaci√≥n', 'ataque', 'intrusi√≥n'
    ],
    security_advice: [
      'consejo', 'advice', 'recomendaci√≥n', 'mejor pr√°ctica', 'protecci√≥n',
      'c√≥mo proteger', 'c√≥mo defenderme', 'medidas de seguridad', 'prevenci√≥n',
      'qu√© hacer', 'c√≥mo mejorar', 'recomendaciones'
    ],
    tool_recommendation: [
      'herramienta', 'tool', 'software', 'aplicaci√≥n', 'programa', 'utilidad',
      'qu√© herramienta', 'recomienda herramienta', 'mejor herramienta', 'alternativa',
      'software de seguridad', 'aplicaci√≥n de seguridad'
    ],
    risk_assessment: [
      'riesgo', 'risk', 'peligro', 'amenaza', 'evaluaci√≥n de riesgo',
      'qu√© tan peligroso', 'nivel de riesgo', 'an√°lisis de riesgo',
      'evaluar riesgo', 'medir riesgo', 'clasificar riesgo'
    ],
    technical_explanation: [
      'explica', 'explain', 'qu√© significa', 'c√≥mo funciona', 'definici√≥n',
      't√©cnicamente', 'detalles t√©cnicos', 'explicaci√≥n t√©cnica', 'c√≥mo se hace',
      'proceso', 'm√©todo', 't√©cnica'
    ],
    compliance_check: [
      'cumplimiento', 'compliance', 'norma', 'est√°ndar', 'regulaci√≥n',
      'gdpr', 'hipaa', 'sox', 'pci', 'iso', 'certificaci√≥n',
      'auditor√≠a', 'audit', 'verificaci√≥n de cumplimiento'
    ],
    incident_response: [
      'incidente', 'incident', 'ataque', 'breach', 'intrusi√≥n',
      'qu√© hacer si', 'respuesta a incidente', 'plan de respuesta',
      'emergencia', 'crisis', 'alerta de seguridad'
    ],
    penetration_testing: [
      'pentest', 'penetration test', 'testing de penetraci√≥n', 'prueba de penetraci√≥n',
      'ethical hacking', 'hacking √©tico', 'test de seguridad', 'auditor√≠a de seguridad',
      'simulaci√≥n de ataque', 'red team'
    ]
  };

  // Verificar si es un reporte de seguridad espec√≠fico
  if (scanType && scanData) {
    return 'security_report';
  }

  // Clasificar basado en palabras clave con prioridad
  for (const [type, words] of Object.entries(keywords)) {
    if (words.some(word => message.includes(word))) {
      return type as AIQueryType;
    }
  }

  // An√°lisis de contexto para determinar el tipo
  if (context) {
    // Si hay un escaneo activo y la pregunta es sobre √©l
    if (context.currentScan && (
      message.includes('este escaneo') || 
      message.includes('los resultados') || 
      message.includes('lo que encontraste')
    )) {
      return 'vulnerability_analysis';
    }

    // Si la conversaci√≥n previa fue sobre herramientas
    if (context.previousTopics.some(topic => 
      topic.includes('herramienta') || topic.includes('tool')
    )) {
      return 'tool_recommendation';
    }

    // Si la conversaci√≥n previa fue sobre vulnerabilidades
    if (context.previousTopics.some(topic => 
      topic.includes('vulnerabilidad') || topic.includes('exploit')
    )) {
      return 'vulnerability_analysis';
    }
  }

  // Por defecto, es chat general
  return 'general_chat';
}

// Funci√≥n para generar el prompt apropiado
export function generatePrompt(query: AIQuery): string {
  switch (query.type) {
    case 'security_report':
      return AI_PROMPTS.security_report(query.scanType!, query.scanData!);
    
    case 'general_chat':
      return AI_PROMPTS.general_chat(query.userMessage!);
    
    case 'vulnerability_analysis':
      return AI_PROMPTS.vulnerability_analysis(query.scanData!, query.context || '');
    
    case 'security_advice':
      return AI_PROMPTS.security_advice(query.userMessage!);
    
    case 'tool_recommendation':
      return AI_PROMPTS.tool_recommendation(query.context || '');
    
    case 'risk_assessment':
      return AI_PROMPTS.risk_assessment(query.scanData!);
    
    case 'technical_explanation':
      return AI_PROMPTS.technical_explanation(query.userMessage!, query.conversationHistory ? { conversationHistory: query.conversationHistory } as ConversationContext : undefined);
    
    case 'compliance_check':
      return AI_PROMPTS.compliance_check(query.userMessage!, query.conversationHistory ? { conversationHistory: query.conversationHistory } as ConversationContext : undefined);
    
    case 'incident_response':
      return AI_PROMPTS.incident_response(query.userMessage!, query.conversationHistory ? { conversationHistory: query.conversationHistory } as ConversationContext : undefined);
    
    case 'penetration_testing':
      return AI_PROMPTS.penetration_testing(query.userMessage!, query.conversationHistory ? { conversationHistory: query.conversationHistory } as ConversationContext : undefined);
    
    default:
      return AI_PROMPTS.general_chat(query.userMessage || '');
  }
}

// Funci√≥n para procesar la consulta del usuario
export function processAIQuery(
  userMessage: string, 
  scanType?: string, 
  scanData?: any
): { prompt: string; queryType: AIQueryType } {
  const queryType = classifyQuery(userMessage, scanType, scanData);
  
  const query: AIQuery = {
    type: queryType,
    scanType,
    scanData,
    userMessage,
    context: userMessage
  };

  const prompt = generatePrompt(query);
  
  return { prompt, queryType };
}

// Sugerencias contextuales basadas en el tipo de consulta
export const CONTEXTUAL_SUGGESTIONS = {
  security_report: [
    "¬øCu√°l es el nivel de riesgo de estos hallazgos?",
    "¬øQu√© medidas de mitigaci√≥n recomiendas?",
    "¬øNecesito actualizar mi configuraci√≥n de seguridad?",
    "¬øQu√© herramientas adicionales puedo usar?"
  ],
  general_chat: [
    "¬øPuedes explicarme m√°s sobre este tema?",
    "¬øQu√© herramientas recomiendas para esto?",
    "¬øCu√°les son las mejores pr√°cticas?",
    "¬øHay alg√∫n recurso adicional que pueda consultar?"
  ],
  vulnerability_analysis: [
    "¬øC√≥mo puedo explotar esta vulnerabilidad?",
    "¬øQu√© contramedidas espec√≠ficas debo implementar?",
    "¬øCu√°l es el impacto potencial de esta vulnerabilidad?",
    "¬øNecesito notificar a alguien sobre esto?"
  ],
  security_advice: [
    "¬øPuedes darme ejemplos pr√°cticos?",
    "¬øQu√© herramientas me ayudan con esto?",
    "¬øCu√°les son los errores m√°s comunes?",
    "¬øC√≥mo puedo verificar que estoy protegido?"
  ],
  tool_recommendation: [
    "¬øEsta herramienta es gratuita?",
    "¬øCu√°l es la curva de aprendizaje?",
    "¬øHay alternativas m√°s simples?",
    "¬øC√≥mo se integra con mi flujo de trabajo?"
  ],
  risk_assessment: [
    "¬øCu√°l es la probabilidad de que esto ocurra?",
    "¬øQu√© impacto tendr√≠a en mi negocio?",
    "¬øCu√°les son mis opciones de mitigaci√≥n?",
    "¬øNecesito un plan de respuesta a incidentes?"
  ],
  technical_explanation: [
    "¬øPuedes darme un ejemplo pr√°ctico?",
    "¬øQu√© herramientas est√°n relacionadas con esto?",
    "¬øCu√°les son las mejores pr√°cticas?",
    "¬øHay alg√∫n recurso para aprender m√°s?"
  ],
  compliance_check: [
    "¬øQu√© consecuencias tiene no cumplir?",
    "¬øCu√°nto tiempo toma implementar esto?",
    "¬øNecesito un auditor externo?",
    "¬øQu√© documentaci√≥n necesito?"
  ],
  incident_response: [
    "¬øCu√°les son los primeros pasos cr√≠ticos?",
    "¬øA qui√©n debo notificar primero?",
    "¬øQu√© herramientas forenses necesito?",
    "¬øC√≥mo documentar todo el proceso?"
  ],
  penetration_testing: [
    "¬øCu√°l es el alcance recomendado?",
    "¬øQu√© metodolog√≠a debo seguir?",
    "¬øQu√© herramientas son esenciales?",
    "¬øC√≥mo preparar el reporte final?"
  ]
};

// Funci√≥n para obtener sugerencias contextuales
export function getContextualSuggestions(queryType: AIQueryType): string[] {
  return CONTEXTUAL_SUGGESTIONS[queryType] || CONTEXTUAL_SUGGESTIONS.general_chat;
} 